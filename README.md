# 三术 / sansu

> **道生一，一生二，二生三，三生万物**

三术 (Sansu) 是一个集成了 **智 (zhi)**、**记 (ji)**、**搜 (sou)** 三大核心能力的 AI 辅助编程增强系统。它通过 MCP (Model Context Protocol) 协议与 AI 助手深度协同，实现了从被动应答到主动协作的范式转变。

## 🌟 核心功能

三术由三个相辅相成的核心工具组成：

### 1. zhi (智/审) - 智能代码审查与交互
**"审时度势，智在必行"**
- **交互式决策**：通过 MCP 弹窗主动询问用户意图，避免 AI 自作主张。
- **多模态输入**：支持文本、图片、预定义选项等多种交互方式。
- **状态可视化**：实时展示后端任务状态（如索引进度），让协作更加透明。

### 2. ji (记) - 记忆管理系统
**"博闻强记，温故知新"**
- **全局记忆**：存储项目级别的规则、偏好、最佳实践和上下文。
- **自动回忆**：每次对话开始时自动加载相关记忆，保持上下文连贯性。
- **分类管理**：支持 Rule (规则)、Preference (偏好)、Pattern (模式)、Context (上下文) 等多维度管理。

### 3. sou (搜) - 代码语义搜索引擎
**"搜神索隐，洞若观火"**
- **语义搜索**：基于 acemcp 引擎，支持自然语言查询代码库。
- **增量索引**：实时监听文件变更，自动维护最新索引。
- **智能等待**：在索引更新时自动平衡速度与完整性。

---

## 🚀 核心特性与流程

### 1. sou 工具的智能等待机制
当 AI 发起搜索请求时，如果系统检测到索引正在更新，会自动进行智能等待，确保结果的准确性。

```ascii
+-----+      Query       +-----+
| AI  | ---------------> | MCP |
+-----+                  +-----+
                            |
                            v
                   +-----------------+
                   |  Index Status?  |
                   +-----------------+
                      /           \
               [Indexing]       [Idle]
                   |               |
                   v               v
           +--------------+   +----------+
           |  Smart Wait  |   |  Search  |
           |  (1-5s Rnd)  |   +----------+
           +--------------+        ^
                   |               |
                   +---------------+
```

### 2. ji 工具的索引预热功能
当用户通过 ji 工具操作记忆时，系统会智能预判可能需要的代码上下文，并在后台默默触发索引预热。

```ascii
+------+    Add/Read    +-----+    Trigger     +--------+
| User | -------------> | ji  | -------------> | Indexer|
+------+     Memory     +-----+   Background   +--------+
                                                   |
                                                   v
                                            +-------------+
                                            | File Watcher|
                                            +-------------+
                                                   |
                                            +-------------+
                                            | Update Index|
                                            +-------------+
```

### 3. zhi 工具的索引状态可视化
在 MCP 弹窗中，用户可以实时看到后台索引的进度，不再面对黑盒等待。

```ascii
+-----+      Request      +-----+      Poll       +--------+
| AI  | ----------------> | zhi | <-------------> | Status |
+-----+                   +-----+                 +--------+
                             |
                             v
                     +---------------+
                     |  Render Popup |
                     | [||||||| 45%] |
                     +---------------+
```

### 4. acemcp 增量索引流程
高效的增量索引机制，确保只处理变更的文件，极大地降低了资源消耗。

```ascii
+-------+    Change    +---------+    Diff    +---------+
| Files | -----------> | Watcher | ---------> | SHA-256 |
+-------+              +---------+            +---------+
                                                   |
                                             [Hash Diff]
                                                   |
                                                   v
                                            +-------------+
                                            | Index Engine|
                                            | (Update DB) |
                                            +-------------+
```

### 5. MCP 工具调用流程
完整的 MCP 调用链路，实现了从 AI 到本地环境的安全、高效交互。

```ascii
+-----+    JSON-RPC    +-----+    Command    +-------+
| AI  | -------------> | MCP | ------------> | Tauri |
+-----+                | Svr |               |  App  |
                       +-----+               +-------+
                                                 |
                                                 v
                                            +---------+
                                            | Rust BE |
                                            +---------+
                                                 |
                                                 v
                                            +---------+
                                            | Action  |
                                            +---------+
```

---

## 🛠️ 技术架构

### 后端架构 (Rust)
- **索引状态管理**：通过 `InitialIndexState` 枚举精确控制索引生命周期。
- **核心函数**：
  - `get_initial_index_state()`: 获取当前索引健康度。
  - `ensure_initial_index_background()`: 确保索引任务在后台可靠运行。
- **高性能**：利用 Rust 的异步特性 (Tokio) 和强类型系统，确保高并发下的稳定性和安全性。

### 前端集成 (TypeScript/Vue 3)
- **响应式状态**：`useAcemcpSync` composable 封装了复杂的同步逻辑。
- **组件化**：`McpPopup` 组件无缝集成了状态展示与交互逻辑。
- **配置管理**：统一的设置界面，支持 `smart_wait_range` (默认 1-5s) 等精细化配置。

---

## 📦 安装与使用

### 安装

1. **克隆仓库**
   ```bash
   git clone https://github.com/yuaotian/sansu.git
   cd sansu
   ```

2. **编译**
   确保已安装 Rust 和 Node.js/pnpm 环境。
   ```bash
   # 安装前端依赖
   pnpm install
   
   # 构建项目
   pnpm build
   cargo build --release
   ```

3. **安装 CLI 工具**
   ```bash
   # 运行安装脚本 (Linux/macOS)
   ./install.sh
   
   # Windows
   ./install-windows.ps1
   ```

### 配置 MCP 客户端

在您的 MCP 客户端配置文件中添加：

```json
{
  "mcpServers": {
    "三术": {
      "command": "三术"
    }
  }
}
```

---

## ☯️ 哲学理念

**"道生一，一生二，二生三，三生万物"**

"三术"的命名灵感源自《道德经》。在 AI 辅助编程的语境下，这象征着从无到有、从简单到复杂的创造过程：

*   **道 (The Way)**：编程的核心思想与逻辑。
*   **一 (One)**：**智 (zhi)**。确立方向，明辨是非。所有的创造始于正确的决策与审查。
*   **二 (Two)**：**记 (ji)**。积累经验，形成规范。在决策的基础上，沉淀为可复用的知识与记忆。
*   **三 (Three)**：**搜 (sou)**。探索未知，连接万物。基于智慧与记忆，通过搜索连接广阔的代码世界。
*   **万物 (Myriad Things)**：通过这三者的循环互动，构建出无限可能的软件生态。

三术不仅仅是一组工具，更是一种 **"控制" (Control)**、**"协作" (Collaboration)** 与 **"智能" (Intelligence)** 的平衡艺术。它让开发者在享受 AI 带来的效率提升的同时，依然牢牢掌握着创造的主导权。

---

## 🙏 致谢

特此感谢 [寸止 (Cunzhi)](https://github.com/imhuso/cunzhi) 项目为本项目提供了坚实的基础。三术 (Sansu) 是在原项目基础上的进一步探索与创新，我们向原作者致以诚挚的谢意。
